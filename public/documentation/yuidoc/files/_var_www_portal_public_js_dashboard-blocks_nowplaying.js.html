<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/var/www/portal/public/js/dashboard-blocks/nowplaying.js - Chell PHP Portal</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
    <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
            <div class="container">
                <div class="row">
                    <a href="../">
                        <img alt="Chell PHP Portal" src="../../../img/icons/favicons/android-chrome-48x48.png" title="Chell PHP Portal">
                        <h1 class="brand">Chell PHP Portal</h1>
                    </a>
                    <ul class="nav">
                        <li class="divider-vertical"></li>
                        <li>
                            <p class="navbar-text">
                                API Docs for Version: <b>1.0</b>
                            </p>
                        </li>
                    </ul>
                    <form class="navbar-form pull-right">
                        <input style="margin-top: 0;" type="text" class="form-control" placeholder="Search for classes/modules..." data-obj='["classes/Devices", "classes/Gallery", "classes/Index", "classes/Nowplaying", "classes/PHPSysInfo", "classes/Transmission", "classes/Window", "modules/Dashboard", "modules/DashboardBlocks", "modules/General", "modules/Settings"]'>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="span3">
                <div>
                    <h3>APIs</h3>
                    <div id="sidebar">
                        <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
                            <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
                            <li><a href="#modules" data-toggle="tab">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" placeholder="Type to filter APIs">
                        </div>
                
                        <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
                            <div class="tab-pane active" id="classes">
                                <ul id="api-classes" class="nav nav-list">
                                        <li><a href="../classes/Devices.html">Devices</a></li>
                                        <li><a href="../classes/Gallery.html">Gallery</a></li>
                                        <li><a href="../classes/Index.html">Index</a></li>
                                        <li><a href="../classes/Nowplaying.html">Nowplaying</a></li>
                                        <li><a href="../classes/PHPSysInfo.html">PHPSysInfo</a></li>
                                        <li><a href="../classes/Transmission.html">Transmission</a></li>
                                        <li><a href="../classes/Window.html">Window</a></li>
                                </ul>
                            </div>
                
                            <div class="tab-pane" id="modules">
                                <ul id="api-modules" class="nav nav-list">
                                        <li><a href="../modules/Dashboard.html">Dashboard</a></li>
                                        <li><a href="../modules/DashboardBlocks.html">DashboardBlocks</a></li>
                                        <li><a href="../modules/General.html">General</a></li>
                                        <li><a href="../modules/Settings.html">Settings</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="span9">
                    <form id="options-form" class="form-inline pull-right">
                        Show:
                        <label for="api-show-inherited" class="checkbox">
                            <input type="checkbox" id="api-show-inherited" checked>
                            Inherited
                        </label>
                
                        <label for="api-show-protected" class="checkbox">
                            <input type="checkbox" id="api-show-protected">
                            Protected
                        </label>
                
                        <label for="api-show-private" class="checkbox">
                            <input type="checkbox" id="api-show-private">
                            Private
                        </label>
                        <label for="api-show-deprecated" class="checkbox">
                            <input type="checkbox" id="api-show-deprecated">
                            Deprecated
                        </label>
                
                    </form>
                
                <div class="apidocs">
                    <div id="docs-main">
                        <div class="content">
                            <div class="page-header">
                                <h1>/var/www/portal/public/js/dashboard-blocks/nowplaying.js <small>File</small></h1>
                            </div>
                            
                            <div class="file">
                                <pre class="prettyprint linenums">
                            ﻿/**
                            * The nowplaying block on the dashboard.
                            * 
                            * @class Nowplaying
                            * @module Dashboard
                            * @submodule DashboardBlocks
                            */
                            (function ($) {
                                $.fn.nowplaying = function (options) {
                            
                                    /**
                                    * All the settings for this block.
                                    * 
                                    * @property settings
                                    * @type Object
                                    */
                                    var settings = $.extend({
                                        block: $(this),
                                        updateInterval: this.data(&quot;nowplaying-intveral&quot;) * 1000,
                                        updateIntervalId: -1,
                                        subsonic: {
                                            loading: false,
                                            url: $(this).data(&quot;subsonic-url&quot;),
                                            password: $(this).data(&quot;subsonic-password&quot;),
                                            username: $(this).data(&quot;subsonic-username&quot;),
                                            timeout: 5000
                                        },
                                        kodi: {
                                            loading: false,
                                            url: $(this).data(&quot;kodi-url&quot;),
                                            urlJSON: $(this).data(&quot;kodi-url&quot;) + &quot;/jsonrpc&quot;,
                                            password: $(this).data(&quot;kodi-password&quot;),
                                            username: $(this).data(&quot;kodi-username&quot;),
                                            timeout: 5000
                                        },
                                    }, options);
                            
                                    /**
                                    * All the functions for this block.
                                    * 
                                    * @property functions
                                    * @type Object
                                    */
                                    var functions = {
                            
                                        /**
                                        * Initializes the eventhandlers for button clicks to navigate between nowplaying  items and sets the refresh button click handler.
                                        * 
                                        * @method initialize
                                        */
                                        initialize: function () {
                                            settings.block.find(&quot;.glyphicon-refresh&quot;).click(function () {
                                                functions.nowPlaying();
                                            });
                            
                                            settings.block.find(&quot;.glyphicon-chevron-left, .glyphicon-chevron-right&quot;).click(function () {
                                                functions.rotate($(this).hasClass(&quot;glyphicon-chevron-left&quot;) ? &quot;left&quot; : &quot;right&quot;);
                                            });
                            
                                            functions.nowPlaying(true);
                                        },
                            
                                        /**
                                        * Wrapper function to retrieve all nowplaying details. 
                                        * 
                                        * @method nowPlaying
                                        * @param onload {Boolean} Whether this function is called as part of initialization
                                        */
                                        nowPlaying: function (onload) {
                                            onload = typeof onload === &#x27;undefined&#x27; ? false : onload;
                            
                                            if (!onload) {
                                                $(&quot;.nowplaying&quot;).isLoading();
                                            }
                            
                                            functions.setInterval();
                            
                                            settings.block.find(&quot;.panel-heading button.glyphicon-chevron-left, .panel-heading button.glyphicon-chevron-right&quot;).addClass(&quot;disabled&quot;);
                                            settings.block.find(&quot;.player.nothing-playing&quot;).hide();
                                            settings.block.find(&quot;.player:not(.nothing-playing)&quot;).remove();
                            
                                            functions.subsonic.nowPlaying();
                                            functions.kodi.nowPlaying();
                            
                                            var checkloadingInterval = window.setInterval(function () {
                                                if (!onload &amp;&amp; settings.kodi.loading == false &amp;&amp; settings.subsonic.loading == false) {
                                                    $(&quot;.nowplaying&quot;).isLoading(&quot;hide&quot;);
                                                    clearInterval(checkloadingInterval);
                                                }
                                            }, 100);
                                        },
                            
                                        /**
                                        * Called on completing AJAX request to retrieve nowplaying details for either Kodi or Subsonic.&lt;br /&gt;
                                        * Hides and shows certain DOM elements based on what&#x27;s playing.
                                        * 
                                        * @method nowPlayingCallback
                                        */
                                        nowPlayingCallback: function () {
                                            if (settings.kodi.loading == false &amp;&amp; settings.subsonic.loading == false) {
                                                var playerCount = settings.block.find(&quot;.player:not(.nothing-playing)&quot;).length;
                            
                                                if (playerCount &gt; 0) {
                                                    settings.block.find(&quot;.player.nothing-playing&quot;).hide();
                                                }
                                                else {
                                                    settings.block.find(&quot;.player.nothing-playing&quot;).show();
                                                }
                            
                                                if (playerCount &lt;= 1) {
                                                    settings.block.find(&quot;.panel-heading button.glyphicon-chevron-left, .panel-heading button.glyphicon-chevron-right&quot;).addClass(&quot;disabled&quot;);
                                                }
                                                else {
                                                    settings.block.find(&quot;.panel-heading button.glyphicon-chevron-left, .panel-heading button.glyphicon-chevron-right&quot;).removeClass(&quot;disabled&quot;);
                                                }
                            
                                                var title = settings.block.find(&quot;.player:visible&quot;).hasClass(&quot;kodi&quot;) ? &quot;Kodi&quot; : &quot;Subsonic&quot;;
                                                settings.block.find(&quot;h4&quot;).html(title);
                                            }
                                        },
                            
                                        /**
                                        * Sets the interval to retreive new nowplaying information automatically.
                                        * 
                                        * @method setInterval
                                        */
                                        setInterval: function () {
                                            clearInterval(settings.updateIntervalId);
                                            settings.updateIntervalId = setInterval(function () {
                                                settings.block.find(&quot;.player:not(.nothing-playing)&quot;).remove();
                            
                                                functions.subsonic.nowPlaying();
                                                functions.kodi.nowPlaying();
                                            }, settings.updateInterval);
                                        },
                            
                                        /**
                                        * Rotates the block to the next/prev player. Called by interval or pressing next/prev buttons.
                                        * 
                                        * @method rotate
                                        * @param direction {String} Which direction to rotate to. Valid values are &quot;left&quot; and &quot;right&quot;.
                                        */
                                        rotate: function (direction) {
                                            var currentIndex = settings.block.find(&quot;.player:visible&quot;).index();
                                            var offset = direction == &quot;right&quot; ? 1 : -1;
                                            var nextIndex = 1;
                                            var nextBlock = settings.block.find(&quot;.player:eq(&quot; + (currentIndex + offset) + &quot;)&quot;);
                            
                                            if (nextBlock.length == 1 &amp;&amp; !nextBlock.hasClass(&quot;nothing-playing&quot;)) {
                                                nextIndex = currentIndex + offset;
                                            }
                                            else if (nextBlock.hasClass(&quot;nothing-playing&quot;)) {
                                                nextIndex = settings.block.find(&quot;.player&quot;).length - 1;
                                            }
                            
                                            if (currentIndex != nextIndex) {
                                                settings.block.find(&quot;.player:eq(&quot; + currentIndex + &quot;)&quot;).fadeOut(&quot;fast&quot;, function () {
                                                    settings.block.find(&quot;.player:eq(&quot; + nextIndex + &quot;)&quot;).fadeIn(&quot;fast&quot;, function () {
                                                        var title = settings.block.find(&quot;.player:visible&quot;).hasClass(&quot;kodi&quot;) ? &quot;Kodi&quot; : &quot;Subsonic&quot;;
                                                        settings.block.find(&quot;h4&quot;).html(title);
                                                    }).css(&quot;display&quot;, &quot;block&quot;);
                                                });
                                            }
                                        },
                            
                                        /**
                                        * Clones the .player.nothing-playing and uses it to set up a new player based on the supplied values.
                                        * 
                                        * @method createPlayer
                                        * @param values {Object} The values to set for the new player.
                                        */
                                        createPlayer: function (values) {
                                            var clone = settings.block.find(&quot;.player.nothing-playing&quot;).clone();
                                            var fancybox = clone.find(&quot;#nowplaying_detail&quot;).attr(&quot;id&quot;, &quot;nowplaying_detail_&quot; + values.index);
                            
                                            clone.removeClass(&quot;nothing-playing&quot;);
                                            clone.addClass(values.type);
                            
                                            clone.find(&quot;.item&quot;).css(&quot;background-image&quot;, &quot;url(&quot; + values.bgImage + &quot;)&quot;)
                                                .attr({ title: $(this).attr(&quot;title&quot;), href: &quot;#nowplaying_detail_&quot; + values.index })
                                                .removeClass(&quot;disabled&quot;);
                            
                                            clone.find(&quot;.title&quot;).html(values.title);
                                            clone.find(&quot;.subtitle&quot;).html(values.subtitle);
                            
                                            fancybox.find(&quot;h4&quot;).html(values.title);
                                            fancybox.find(&quot;.track&quot;).html(values.track);
                                            fancybox.find(&quot;.album&quot;).html(values.album);
                                            fancybox.find(&quot;.year&quot;).html(values.year);
                                            fancybox.find(&quot;.genre&quot;).html(values.genre);
                                            fancybox.find(&quot;.duration&quot;).html(values.duration);
                                            fancybox.find(&quot;.bitrate&quot;).html(values.bitRate) + &quot; kb/s&quot;;
                                            fancybox.find(&quot;.playcount&quot;).html(values.playCount);
                                            fancybox.find(&quot;.lastplayed&quot;).html(values.lastplayed + &quot; minutes ago&quot;);
                            
                                            if (settings.block.find(&quot;.player:not(.nothing-playing):visible&quot;).length != 0) {
                                                clone.hide();
                                            }
                                            else {
                                                clone.show();
                                            }
                            
                                            clone.appendTo(settings.block.find(&quot;.panel-body&quot;));
                                        },
                            
                                        /**
                                        * The Subsonic object containing all the functions related to Subsonic nowplaying.
                                        * 
                                        * @property subsonic
                                        * @type Object
                                        * @example http://www.subsonic.org/pages/api.jsp
                                        */
                                        subsonic: {
                            
                                            /**
                                            * Retrieves the nowplaying information from SubSonic. On complete calls functions.nowPlayingCallback().
                                            * 
                                            * @method subsonic.nowPlaying
                                            */
                                            nowPlaying: function () {
                                                settings.subsonic.loading = true;
                            
                                                $.ajax({
                                                    url: functions.subsonic.getURL(&quot;getNowPlaying&quot;),
                                                    timeout: settings.subsonic.timeout,
                                                    success: function (nowPlayingData) {
                                                        var entry = $(nowPlayingData).find(&quot;entry&quot;);
                            
                                                        if (entry.length != 0) {
                                                            entry.each(function (index, value) {
                                                                var bgImage = functions.subsonic.getURL(&quot;getCoverArt&quot;, { id: $(this).attr(&quot;coverArt&quot;) });
                                                                var duration = Math.floor($(this).attr(&quot;duration&quot;) / 60) + &quot;:&quot; + ($(this).attr(&quot;duration&quot;) % 60);
                            
                                                                functions.createPlayer({
                                                                    type: &quot;subsonic&quot;,
                                                                    index: index,
                                                                    bgImage: bgImage,
                                                                    title: $(this).attr(&quot;artist&quot;),
                                                                    subtitle: $(this).attr(&quot;title&quot;),
                                                                    track: $(this).attr(&quot;track&quot;),
                                                                    album: $(this).attr(&quot;album&quot;),
                                                                    genre: $(this).attr(&quot;genre&quot;),
                                                                    duration: duration,
                                                                    bitrate: $(this).attr(&quot;bitRate&quot;),
                                                                    playCount: $(this).attr(&quot;playCount&quot;),
                                                                    lastPlayed: $(this).attr(&quot;minutesAgo&quot;)
                                                                });
                                                            });
                                                        }
                                                    },
                                                    complete: function () {
                                                        settings.subsonic.loading = false;
                                                        functions.nowPlayingCallback();
                                                    }
                                                });
                                            },
                            
                            
                                            /**
                                            * Creates a salt, used to salt the login information with. Used by functions.subsonic.getURL.
                                            * 
                                            * @method subsonic.getSalt
                                            */
                                            getSalt: function () {
                                                return Math.random().toString(36).substring(7);
                                            },
                            
                                            /**
                                            * Creates a SubSonic style REST URL with username, password and salt.&lt;br /&gt;
                                            * Pass along an Array of arguments to append them to the URL.
                                            * 
                                            * @method subsonic.getURL
                                            * @param view {String} Which SubSonic view to retrieve.
                                            * @param arguments {Array} The extra arguments to append to the REST URL. The key will be used as the queryparameter, the value as queryvalue.
                                            */
                                            getURL: function (view, arguments) {
                                                var salt = functions.subsonic.getSalt();
                                                var password = md5(settings.subsonic.password + salt);
                                                var url = settings.subsonic.url + &quot;rest/&quot; + view + &quot;.view?u=&quot; + settings.subsonic.username + &quot;&amp;t=&quot; + password + &quot;&amp;s=&quot; + salt + &quot;&amp;v=1.14.0&amp;c=chell&quot;;
                            
                                                $.each(arguments, function (key, value) {
                                                    url += &quot;&amp;&quot; + key + &quot;=&quot; + value;
                                                });
                            
                                                return url;
                                            },
                                        },
                            
                                        /**
                                        * The Kodi object containing all the functions related to Kodi nowplaying.
                                        * 
                                        * @property kodi
                                        * @type Object
                                        * @example http://kodi.wiki/view/JSON-RPC_API
                                        * @example http://kodi.wiki/view/JSON-RPC_API/Examples
                                        * @example http://forum.kodi.tv/showthread.php?tid=157996
                                        */
                                        kodi: {
                                            /**
                                            * Retrieves the nowplaying information from Kodi. On complete calls functions.nowPlayingCallback().
                                            * 
                                            * @method kodi.nowPlaying
                                            */
                                            nowPlaying: function () {
                                                settings.kodi.loading = true;
                            
                                                var data = {
                                                    id: 1,
                                                    jsonrpc: &quot;2.0&quot;,
                                                    method: &quot;Player.GetItem&quot;,
                                                    params: [0, [&quot;title&quot;, &quot;artist&quot;, &quot;thumbnail&quot;]]
                                                };
                            
                                                $.ajax({
                                                    url: settings.kodi.urlJSON,
                                                    type: &quot;POST&quot;,
                                                    contentType: &quot;application/json&quot;,
                                                    data: JSON.stringify(data),
                                                    timeout: settings.kodi.timeout,
                                                    beforeSend: function (xhr) {
                                                        xhr.setRequestHeader(&#x27;Authorization&#x27;, &#x27;Basic &#x27; + btoa(settings.kodi.username + &#x27;:&#x27; + settings.kodi.password));
                                                    },
                                                    success: function (response) {
                                                        if ($.trim(response.result.item.title) != &quot;&quot;) {
                                                            var bgImage = encodeURI(response.result.item.thumbnail);
                                                            bgImage = settings.kodi.url.replace(&quot;//&quot;, &quot;//&quot; + settings.kodi.username + &quot;:&quot; + settings.kodi.password + &quot;@&quot;) + &quot;/image/&quot; + bgImage;
                            
                                                            functions.createPlayer({
                                                                type: &quot;kodi&quot;,
                                                                index: 99,
                                                                bgImage: bgImage,
                                                                title: response.result.item.artist,
                                                                subtitle: response.result.item.title,
                                                            });
                                                        }
                                                    },
                                                    complete: function () {
                                                        settings.kodi.loading = false;
                                                        functions.nowPlayingCallback();
                                                    }
                                                });
                                            },
                                        }
                                    };
                            
                                    functions.initialize();
                            
                                    return functions;
                                }
                            })(jQuery);
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
    <script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
    <script src="../assets/vendor/prettify/prettify-min.js"></script>
    <script src="../assets/js/yuidoc-bootstrap.js"></script>
    <script>prettyPrint();</script>
</body>
</html>