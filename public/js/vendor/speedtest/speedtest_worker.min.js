function tlog(n){settings.telemetry_level>=2&&(log+=Date.now()+": "+n+"\n")}function tverb(n){settings.telemetry_level>=3&&(log+=Date.now()+": "+n+"\n")}function twarn(n){settings.telemetry_level>=2&&(log+=Date.now()+" WARN: "+n+"\n");console.warn(n)}function url_sep(n){return n.match(/\?/)?"&":"?"}function clearRequests(){if(tverb("stopping pending XHRs"),xhr){for(var n=0;n<xhr.length;n++){try{xhr[n].onprogress=null;xhr[n].onload=null;xhr[n].onerror=null}catch(t){}try{xhr[n].upload.onprogress=null;xhr[n].upload.onload=null;xhr[n].upload.onerror=null}catch(t){}try{xhr[n].abort()}catch(t){}try{delete xhr[n]}catch(t){}}xhr=null}}function getIp(n){if(tverb("getIp"),!ipCalled){ipCalled=!0;var t=(new Date).getTime();xhr=new XMLHttpRequest;xhr.onload=function(){tlog("IP: "+xhr.responseText+", took "+((new Date).getTime()-t)+"ms");try{var i=JSON.parse(xhr.responseText);clientIp=i.processedString;ispInfo=i.rawIspInfo}catch(r){clientIp=xhr.responseText;ispInfo=""}n()};xhr.onerror=function(){tlog("getIp failed, took "+((new Date).getTime()-t)+"ms");n()};xhr.open("GET",settings.url_getIp+url_sep(settings.url_getIp)+(settings.mpot?"cors=true&":"")+(settings.getIp_ispInfo?"isp=true"+(settings.getIp_ispInfo_distance?"&distance="+settings.getIp_ispInfo_distance+"&":"&"):"&")+"r="+Math.random(),!0);xhr.send()}}function dlTest(n){var f,t;if(tverb("dlTest"),!dlCalled){dlCalled=!0;var i=0,e=(new Date).getTime(),r=0,u=!1,o=!1;for(xhr=[],f=function(n,t){setTimeout(function(){if(testState===1){tverb("dl test stream started "+n+" "+t);var r=0,u=new XMLHttpRequest;xhr[n]=u;xhr[n].onprogress=function(t){if(tverb("dl stream progress event "+n+" "+t.loaded),testState!==1)try{u.abort()}catch(e){}var f=t.loaded<=0?0:t.loaded-r;isNaN(f)||!isFinite(f)||f<0||(i+=f,r=t.loaded)}.bind(this);xhr[n].onload=function(){tverb("dl stream finished "+n);try{xhr[n].abort()}catch(t){}f(n,0)}.bind(this);xhr[n].onerror=function(){tverb("dl stream failed "+n);settings.xhr_ignoreErrors===0&&(o=!0);try{xhr[n].abort()}catch(t){}delete xhr[n];settings.xhr_ignoreErrors===1&&f(n,0)}.bind(this);try{xhr[n].responseType=settings.xhr_dlUseBlob?"blob":"arraybuffer"}catch(e){}xhr[n].open("GET",settings.url_dl+url_sep(settings.url_dl)+(settings.mpot?"cors=true&":"")+"r="+Math.random()+"&ckSize="+settings.garbagePhp_chunkSize,!0);xhr[n].send()}}.bind(this),1+t)}.bind(this),t=0;t<settings.xhr_dlMultistream;t++)f(t,settings.xhr_multistreamDelay*t);interval=setInterval(function(){var t,f,s;(tverb("DL: "+dlStatus+(u?"":" (in grace time)")),t=(new Date).getTime()-e,u&&(dlProgress=(t+r)/(settings.time_dl_max*1e3)),t<200)||(u?(f=i/(t/1e3),settings.time_auto&&(s=6.4*f/1e5,r+=s>800?800:s),dlStatus=(f*8*settings.overheadCompensationFactor/(settings.useMebibits?1048576:1e6)).toFixed(2),((t+r)/1e3>settings.time_dl_max||o)&&((o||isNaN(dlStatus))&&(dlStatus="Fail"),clearRequests(),clearInterval(interval),dlProgress=1,tlog("dlTest: "+dlStatus+", took "+((new Date).getTime()-e)+"ms"),n())):t>1e3*settings.time_dlGraceTime&&(i>0&&(e=(new Date).getTime(),r=0,i=0),u=!0))}.bind(this),200)}}function ulTest(n){var t,f,u,r,i,e;if(tverb("ulTest"),!ulCalled){ulCalled=!0;t=new ArrayBuffer(1048576);f=Math.pow(2,32)-1;try{for(t=new Uint32Array(t),i=0;i<t.length;i++)t[i]=Math.random()*f}catch(o){}for(u=[],r=[],i=0;i<settings.xhr_ul_blob_megabytes;i++)u.push(t);u=new Blob(u);t=new ArrayBuffer(262144);try{for(t=new Uint32Array(t),i=0;i<t.length;i++)t[i]=Math.random()*f}catch(o){}r.push(t);r=new Blob(r);e=function(){var t=0,s=(new Date).getTime(),e=0,o=!1,h=!1,i,f;for(xhr=[],i=function(n,f){setTimeout(function(){var o,s,e;if(testState===3){if(tverb("ul test stream started "+n+" "+f),o=0,s=new XMLHttpRequest,xhr[n]=s,settings.forceIE11Workaround)e=!0;else try{xhr[n].upload.onprogress;e=!1}catch(c){e=!0}if(e){xhr[n].onload=xhr[n].onerror=function(){tverb("ul stream progress event (ie11wa)");t+=r.size;i(n,0)};xhr[n].open("POST",settings.url_ul+url_sep(settings.url_ul)+(settings.mpot?"cors=true&":"")+"r="+Math.random(),!0);try{xhr[n].setRequestHeader("Content-Encoding","identity")}catch(c){}xhr[n].send(r)}else{xhr[n].upload.onprogress=function(i){if(tverb("ul stream progress event "+n+" "+i.loaded),testState!==3)try{s.abort()}catch(u){}var r=i.loaded<=0?0:i.loaded-o;isNaN(r)||!isFinite(r)||r<0||(t+=r,o=i.loaded)}.bind(this);xhr[n].upload.onload=function(){tverb("ul stream finished "+n);i(n,0)}.bind(this);xhr[n].upload.onerror=function(){tverb("ul stream failed "+n);settings.xhr_ignoreErrors===0&&(h=!0);try{xhr[n].abort()}catch(t){}delete xhr[n];settings.xhr_ignoreErrors===1&&i(n,0)}.bind(this);xhr[n].open("POST",settings.url_ul+url_sep(settings.url_ul)+(settings.mpot?"cors=true&":"")+"r="+Math.random(),!0);try{xhr[n].setRequestHeader("Content-Encoding","identity")}catch(c){}xhr[n].send(u)}}}.bind(this),1)}.bind(this),f=0;f<settings.xhr_ulMultistream;f++)i(f,settings.xhr_multistreamDelay*f);interval=setInterval(function(){var i,r,u;(tverb("UL: "+ulStatus+(o?"":" (in grace time)")),i=(new Date).getTime()-s,o&&(ulProgress=(i+e)/(settings.time_ul_max*1e3)),i<200)||(o?(r=t/(i/1e3),settings.time_auto&&(u=6.4*r/1e5,e+=u>800?800:u),ulStatus=(r*8*settings.overheadCompensationFactor/(settings.useMebibits?1048576:1e6)).toFixed(2),((i+e)/1e3>settings.time_ul_max||h)&&((h||isNaN(ulStatus))&&(ulStatus="Fail"),clearRequests(),clearInterval(interval),ulProgress=1,tlog("ulTest: "+ulStatus+", took "+((new Date).getTime()-s)+"ms"),n())):i>1e3*settings.time_ulGraceTime&&(t>0&&(s=(new Date).getTime(),e=0,t=0),o=!0))}.bind(this),200)}.bind(this);settings.mpot?(tverb("Sending POST request before performing upload test"),xhr=[],xhr[0]=new XMLHttpRequest,xhr[0].onload=xhr[0].onerror=function(){tverb("POST request sent, starting upload test");e()}.bind(this),xhr[0].open("POST",settings.url_ul),xhr[0].send()):e()}}function pingTest(n){var r;if(tverb("pingTest"),!ptCalled){ptCalled=!0;var f=(new Date).getTime(),e=null,u=0,i=0,t=0,o=0;xhr=[];r=function(){tverb("ping");pingProgress=t/settings.count_ping;e=(new Date).getTime();xhr[0]=new XMLHttpRequest;xhr[0].onload=function(){var s,h,c,l;if(tverb("pong"),t===0)e=(new Date).getTime();else{if(s=(new Date).getTime()-e,settings.ping_allowPerformanceApi)try{h=performance.getEntries();h=h[h.length-1];c=h.responseStart-h.requestStart;c<=0&&(c=h.duration);c>0&&c<s&&(s=c)}catch(a){tverb("Performance API not supported, using estimate")}s<1&&(s=o);s<1&&(s=1);l=Math.abs(s-o);t===1?u=s:(s<u&&(u=s),i=t===2?l:l>i?i*.3+l*.7:i*.8+l*.2);o=s}pingStatus=u.toFixed(2);jitterStatus=i.toFixed(2);t++;tverb("ping: "+pingStatus+" jitter: "+jitterStatus);t<settings.count_ping?r():(pingProgress=1,tlog("ping: "+pingStatus+" jitter: "+jitterStatus+", took "+((new Date).getTime()-f)+"ms"),n())}.bind(this);xhr[0].onerror=function(){tverb("ping failed");settings.xhr_ignoreErrors===0&&(pingStatus="Fail",jitterStatus="Fail",clearRequests(),tlog("ping test failed, took "+((new Date).getTime()-f)+"ms"),pingProgress=1,n());settings.xhr_ignoreErrors===1&&r();settings.xhr_ignoreErrors===2&&(t++,t<settings.count_ping?r():(pingProgress=1,tlog("ping: "+pingStatus+" jitter: "+jitterStatus+", took "+((new Date).getTime()-f)+"ms"),n()))}.bind(this);xhr[0].open("GET",settings.url_ping+url_sep(settings.url_ping)+(settings.mpot?"cors=true&":"")+"r="+Math.random(),!0);xhr[0].send()}.bind(this);r()}}function sendTelemetry(n){var i,t,r;if(!(settings.telemetry_level<1)){xhr=new XMLHttpRequest;xhr.onload=function(){var t,i;try{if(t=xhr.responseText.split(" "),t[0]=="id")try{i=t[1];n(i)}catch(r){n(null)}else n(null)}catch(r){n(null)}};xhr.onerror=function(){console.log("TELEMETRY ERROR "+xhr.status);n(null)};xhr.open("POST",settings.url_telemetry+url_sep(settings.url_telemetry)+(settings.mpot?"cors=true&":"")+"r="+Math.random(),!0);i={processedString:clientIp,rawIspInfo:typeof ispInfo=="object"?ispInfo:""};try{t=new FormData;t.append("ispinfo",JSON.stringify(i));t.append("dl",dlStatus);t.append("ul",ulStatus);t.append("ping",pingStatus);t.append("jitter",jitterStatus);t.append("log",settings.telemetry_level>1?log:"");t.append("extra",settings.telemetry_extra);xhr.send(t)}catch(u){r="extra="+encodeURIComponent(settings.telemetry_extra)+"&ispinfo="+encodeURIComponent(JSON.stringify(i))+"&dl="+encodeURIComponent(dlStatus)+"&ul="+encodeURIComponent(ulStatus)+"&ping="+encodeURIComponent(pingStatus)+"&jitter="+encodeURIComponent(jitterStatus)+"&log="+encodeURIComponent(settings.telemetry_level>1?log:"");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.send(r)}}}var testState=-1,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",clientIp="",dlProgress=0,ulProgress=0,pingProgress=0,testId=null,log="",settings={mpot:!1,test_order:"IP_D_U",time_ul_max:15,time_dl_max:15,time_auto:!0,time_ulGraceTime:3,time_dlGraceTime:1.5,count_ping:10,url_dl:"garbage.php",url_ul:"empty.php",url_ping:"empty.php",url_getIp:"getIP.php",getIp_ispInfo:!0,getIp_ispInfo_distance:"km",xhr_dlMultistream:6,xhr_ulMultistream:3,xhr_multistreamDelay:300,xhr_ignoreErrors:1,xhr_dlUseBlob:!1,xhr_ul_blob_megabytes:20,garbagePhp_chunkSize:100,enable_quirks:!0,ping_allowPerformanceApi:!0,overheadCompensationFactor:1.06,useMebibits:!1,telemetry_level:0,url_telemetry:"telemetry/telemetry.php",telemetry_extra:""},xhr=null,interval=null,test_pointer=0,ipCalled,ispInfo,dlCalled,ulCalled,ptCalled;this.addEventListener("message",function(n){var f=n.data.split(" "),t,e,u,r;if(f[0]==="status"&&postMessage(JSON.stringify({testState:testState,dlStatus:dlStatus,ulStatus:ulStatus,pingStatus:pingStatus,clientIp:clientIp,jitterStatus:jitterStatus,dlProgress:dlProgress,ulProgress:ulProgress,pingProgress:pingProgress,testId:testId})),f[0]==="start"&&testState===-1){testState=0;try{t={};try{e=n.data.substring(5);e&&(t=JSON.parse(e))}catch(n){twarn("Error parsing custom settings JSON. Please check your syntax")}for(u in t)typeof settings[u]!="undefined"?settings[u]=t[u]:twarn("Unknown setting ignored: "+u);(settings.enable_quirks||typeof t.enable_quirks!="undefined"&&t.enable_quirks)&&(r=navigator.userAgent,/Firefox.(\d+\.\d+)/i.test(r)&&(typeof t.xhr_ulMultistream=="undefined"&&(settings.xhr_ulMultistream=1),typeof t.xhr_ulMultistream=="undefined"&&(settings.ping_allowPerformanceApi=!1)),/Edge.(\d+\.\d+)/i.test(r)&&typeof t.xhr_dlMultistream=="undefined"&&(settings.xhr_dlMultistream=3),/Chrome.(\d+)/i.test(r)&&!!self.fetch&&typeof t.xhr_dlMultistream=="undefined"&&(settings.xhr_dlMultistream=5));/Edge.(\d+\.\d+)/i.test(r)&&(settings.forceIE11Workaround=!0);/PlayStation 4.(\d+\.\d+)/i.test(r)&&(settings.forceIE11Workaround=!0);/Chrome.(\d+)/i.test(r)&&/Android|iPhone|iPad|iPod|Windows Phone/i.test(r)&&(settings.xhr_ul_blob_megabytes=4);/^((?!chrome|android|crios|fxios).)*safari/i.test(r)&&(settings.forceIE11Workaround=!0);typeof t.telemetry_level!="undefined"&&(settings.telemetry_level=t.telemetry_level==="basic"?1:t.telemetry_level==="full"?2:t.telemetry_level==="debug"?3:0);settings.test_order=settings.test_order.toUpperCase()}catch(n){twarn("Possible error in custom test settings. Some settings might not have been applied. Exception: "+n)}tverb(JSON.stringify(settings));test_pointer=0;var o=!1,s=!1,h=!1,c=!1,i=function(){if(testState!=5){if(test_pointer>=settings.test_order.length){settings.telemetry_level>0?sendTelemetry(function(n){testState=4;n!=null&&(testId=n)}):testState=4;return}switch(settings.test_order.charAt(test_pointer)){case"I":if(test_pointer++,o){i();return}o=!0;getIp(i);break;case"D":if(test_pointer++,s){i();return}s=!0;testState=1;dlTest(i);break;case"U":if(test_pointer++,h){i();return}h=!0;testState=3;ulTest(i);break;case"P":if(test_pointer++,c){i();return}c=!0;testState=2;pingTest(i);break;case"_":test_pointer++;setTimeout(i,1e3);break;default:test_pointer++}}};i()}if(f[0]==="abort"){if(testState>=4)return;tlog("manually aborted");clearRequests();i=null;interval&&clearInterval(interval);settings.telemetry_level>1&&sendTelemetry(function(){});testState=5;dlStatus="";ulStatus="";pingStatus="";jitterStatus="";clientIp="";dlProgress=0;ulProgress=0;pingProgress=0}});ipCalled=!1;ispInfo="";dlCalled=!1;ulCalled=!1;ptCalled=!1;
//# sourceMappingURL=speedtest_worker.min.js.map