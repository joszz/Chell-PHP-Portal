/*! chell-php-portal v1.4.0 | (c) 2021 Jos Nienhuis | GPL-2.0 License */
"use strict";var testState=-1,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",clientIp="",dlProgress=0,ulProgress=0,pingProgress=0,testId=null,log="";function tlog(t){2<=settings.telemetry_level&&(log+=Date.now()+": "+t+"\n")}function tverb(t){3<=settings.telemetry_level&&(log+=Date.now()+": "+t+"\n")}function twarn(t){2<=settings.telemetry_level&&(log+=Date.now()+" WARN: "+t+"\n"),console.warn(t)}var settings={mpot:!1,test_order:"IP_D_U",time_ul_max:15,time_dl_max:15,time_auto:!0,time_ulGraceTime:3,time_dlGraceTime:1.5,count_ping:10,url_dl:"backend/garbage.php",url_ul:"backend/empty.php",url_ping:"backend/empty.php",url_getIp:"backend/getIP.php",getIp_ispInfo:!0,getIp_ispInfo_distance:"km",xhr_dlMultistream:6,xhr_ulMultistream:3,xhr_multistreamDelay:300,xhr_ignoreErrors:1,xhr_dlUseBlob:!1,xhr_ul_blob_megabytes:20,garbagePhp_chunkSize:100,enable_quirks:!0,ping_allowPerformanceApi:!0,overheadCompensationFactor:1.06,useMebibits:!1,telemetry_level:0,url_telemetry:"results/telemetry.php",telemetry_extra:""},xhr=null,interval=null,test_pointer=0;function url_sep(t){return t.match(/\?/)?"&":"?"}function clearRequests(){if(tverb("stopping pending XHRs"),xhr){for(var t=0;t<xhr.length;t++){try{xhr[t].onprogress=null,xhr[t].onload=null,xhr[t].onerror=null}catch(t){}try{xhr[t].upload.onprogress=null,xhr[t].upload.onload=null,xhr[t].upload.onerror=null}catch(t){}try{xhr[t].abort()}catch(t){}try{delete xhr[t]}catch(t){}}xhr=null}}this.addEventListener("message",function(t){var e=t.data.split(" ");if("status"===e[0]&&postMessage(JSON.stringify({testState:testState,dlStatus:dlStatus,ulStatus:ulStatus,pingStatus:pingStatus,clientIp:clientIp,jitterStatus:jitterStatus,dlProgress:dlProgress,ulProgress:ulProgress,pingProgress:pingProgress,testId:testId})),"start"===e[0]&&-1===testState){testState=0;try{var r,s={};try{var n=t.data.substring(5);n&&(s=JSON.parse(n))}catch(t){twarn("Error parsing custom settings JSON. Please check your syntax")}for(r in s)void 0!==settings[r]?settings[r]=s[r]:twarn("Unknown setting ignored: "+r);var i=navigator.userAgent;(settings.enable_quirks||void 0!==s.enable_quirks&&s.enable_quirks)&&(/Firefox.(\d+\.\d+)/i.test(i)&&void 0===s.ping_allowPerformanceApi&&(settings.ping_allowPerformanceApi=!1),/Edge.(\d+\.\d+)/i.test(i)&&void 0===s.xhr_dlMultistream&&(settings.xhr_dlMultistream=3),/Chrome.(\d+)/i.test(i)&&self.fetch&&void 0===s.xhr_dlMultistream&&(settings.xhr_dlMultistream=5)),/Edge.(\d+\.\d+)/i.test(i)&&(settings.forceIE11Workaround=!0),/PlayStation 4.(\d+\.\d+)/i.test(i)&&(settings.forceIE11Workaround=!0),/Chrome.(\d+)/i.test(i)&&/Android|iPhone|iPad|iPod|Windows Phone/i.test(i)&&(settings.xhr_ul_blob_megabytes=4),/^((?!chrome|android|crios|fxios).)*safari/i.test(i)&&(settings.forceIE11Workaround=!0),void 0!==s.telemetry_level&&(settings.telemetry_level="basic"===s.telemetry_level?1:"full"===s.telemetry_level?2:"debug"===s.telemetry_level?3:0),settings.test_order=settings.test_order.toUpperCase()}catch(t){twarn("Possible error in custom test settings. Some settings might not have been applied. Exception: "+t)}tverb(JSON.stringify(settings)),test_pointer=0;var a=!1,o=!1,l=!1,u=!1,g=function(){if(5!=testState)if(test_pointer>=settings.test_order.length)0<settings.telemetry_level?sendTelemetry(function(t){testState=4,null!=t&&(testId=t)}):testState=4;else switch(settings.test_order.charAt(test_pointer)){case"I":if(test_pointer++,a)return void g();a=!0,getIp(g);break;case"D":if(test_pointer++,o)return void g();o=!0,testState=1,dlTest(g);break;case"U":if(test_pointer++,l)return void g();l=!0,testState=3,ulTest(g);break;case"P":if(test_pointer++,u)return void g();u=!0,testState=2,pingTest(g);break;case"_":test_pointer++,setTimeout(g,1e3);break;default:test_pointer++}};g()}"abort"===e[0]&&(4<=testState||(tlog("manually aborted"),clearRequests(),g=null,interval&&clearInterval(interval),1<settings.telemetry_level&&sendTelemetry(function(){}),testState=5,clientIp=jitterStatus=pingStatus=ulStatus=dlStatus="",pingProgress=ulProgress=dlProgress=0))});var ipCalled=!1,ispInfo="";function getIp(e){var r;tverb("getIp"),ipCalled||(ipCalled=!0,r=(new Date).getTime(),(xhr=new XMLHttpRequest).onload=function(){tlog("IP: "+xhr.responseText+", took "+((new Date).getTime()-r)+"ms");try{var t=JSON.parse(xhr.responseText);clientIp=t.processedString,ispInfo=t.rawIspInfo}catch(t){clientIp=xhr.responseText,ispInfo=""}e()},xhr.onerror=function(){tlog("getIp failed, took "+((new Date).getTime()-r)+"ms"),e()},xhr.open("GET",settings.url_getIp+url_sep(settings.url_getIp)+(settings.mpot?"cors=true&":"")+(settings.getIp_ispInfo?"isp=true"+(settings.getIp_ispInfo_distance?"&distance="+settings.getIp_ispInfo_distance+"&":"&"):"&")+"r="+Math.random(),!0),xhr.send())}var dlCalled=!1;function dlTest(s){if(tverb("dlTest"),!dlCalled){dlCalled=!0;var i=0,n=(new Date).getTime(),a=0,o=!1,l=!1;xhr=[];for(var e=function(n,t){setTimeout(function(){if(1===testState){tverb("dl test stream started "+n+" "+t);var r=0,s=new XMLHttpRequest;xhr[n]=s,xhr[n].onprogress=function(t){if(tverb("dl stream progress event "+n+" "+t.loaded),1!==testState)try{s.abort()}catch(t){}var e=t.loaded<=0?0:t.loaded-r;isNaN(e)||!isFinite(e)||e<0||(i+=e,r=t.loaded)}.bind(this),xhr[n].onload=function(){tverb("dl stream finished "+n);try{xhr[n].abort()}catch(t){}e(n,0)}.bind(this),xhr[n].onerror=function(){tverb("dl stream failed "+n),0===settings.xhr_ignoreErrors&&(l=!0);try{xhr[n].abort()}catch(t){}delete xhr[n],1===settings.xhr_ignoreErrors&&e(n,0)}.bind(this);try{settings.xhr_dlUseBlob?xhr[n].responseType="blob":xhr[n].responseType="arraybuffer"}catch(t){}xhr[n].open("GET",settings.url_dl+url_sep(settings.url_dl)+(settings.mpot?"cors=true&":"")+"r="+Math.random()+"&ckSize="+settings.garbagePhp_chunkSize,!0),xhr[n].send()}}.bind(this),1+t)}.bind(this),t=0;t<settings.xhr_dlMultistream;t++)e(t,settings.xhr_multistreamDelay*t);interval=setInterval(function(){tverb("DL: "+dlStatus+(o?"":" (in grace time)"));var t,e,r=(new Date).getTime()-n;o&&(dlProgress=(r+a)/(1e3*settings.time_dl_max)),r<200||(o?(t=i/(r/1e3),settings.time_auto&&(a+=400<(e=5*t/1e5)?400:e),dlStatus=(8*t*settings.overheadCompensationFactor/(settings.useMebibits?1048576:1e6)).toFixed(2),((r+a)/1e3>settings.time_dl_max||l)&&((l||isNaN(dlStatus))&&(dlStatus="Fail"),clearRequests(),clearInterval(interval),dlProgress=1,tlog("dlTest: "+dlStatus+", took "+((new Date).getTime()-n)+"ms"),s())):r>1e3*settings.time_dlGraceTime&&(0<i&&(n=(new Date).getTime(),i=a=0),o=!0))}.bind(this),200)}}var ulCalled=!1;function ulTest(u){if(tverb("ulTest"),!ulCalled){ulCalled=!0;var t=new ArrayBuffer(1048576),e=Math.pow(2,32)-1;try{for(var t=new Uint32Array(t),r=0;r<t.length;r++)t[r]=Math.random()*e}catch(t){}for(var g=[],d=[],r=0;r<settings.xhr_ul_blob_megabytes;r++)g.push(t);g=new Blob(g),t=new ArrayBuffer(262144);try{t=new Uint32Array(t);for(r=0;r<t.length;r++)t[r]=Math.random()*e}catch(t){}d.push(t);var d=new Blob(d),s=function(){var i=0,s=(new Date).getTime(),n=0,a=!1,o=!1;xhr=[];for(var l=function(n,t){setTimeout(function(){if(3===testState){tverb("ul test stream started "+n+" "+t);var e,r=0,s=new XMLHttpRequest;if(xhr[n]=s,settings.forceIE11Workaround)e=!0;else try{xhr[n].upload.onprogress,e=!1}catch(t){e=!0}if(e){xhr[n].onload=xhr[n].onerror=function(){tverb("ul stream progress event (ie11wa)"),i+=d.size,l(n,0)},xhr[n].open("POST",settings.url_ul+url_sep(settings.url_ul)+(settings.mpot?"cors=true&":"")+"r="+Math.random(),!0);try{xhr[n].setRequestHeader("Content-Encoding","identity")}catch(t){}xhr[n].send(d)}else{xhr[n].upload.onprogress=function(t){if(tverb("ul stream progress event "+n+" "+t.loaded),3!==testState)try{s.abort()}catch(t){}var e=t.loaded<=0?0:t.loaded-r;isNaN(e)||!isFinite(e)||e<0||(i+=e,r=t.loaded)}.bind(this),xhr[n].upload.onload=function(){tverb("ul stream finished "+n),l(n,0)}.bind(this),xhr[n].upload.onerror=function(){tverb("ul stream failed "+n),0===settings.xhr_ignoreErrors&&(o=!0);try{xhr[n].abort()}catch(t){}delete xhr[n],1===settings.xhr_ignoreErrors&&l(n,0)}.bind(this),xhr[n].open("POST",settings.url_ul+url_sep(settings.url_ul)+(settings.mpot?"cors=true&":"")+"r="+Math.random(),!0);try{xhr[n].setRequestHeader("Content-Encoding","identity")}catch(t){}xhr[n].send(g)}}}.bind(this),t)}.bind(this),t=0;t<settings.xhr_ulMultistream;t++)l(t,settings.xhr_multistreamDelay*t);interval=setInterval(function(){tverb("UL: "+ulStatus+(a?"":" (in grace time)"));var t,e,r=(new Date).getTime()-s;a&&(ulProgress=(r+n)/(1e3*settings.time_ul_max)),r<200||(a?(t=i/(r/1e3),settings.time_auto&&(n+=400<(e=5*t/1e5)?400:e),ulStatus=(8*t*settings.overheadCompensationFactor/(settings.useMebibits?1048576:1e6)).toFixed(2),((r+n)/1e3>settings.time_ul_max||o)&&((o||isNaN(ulStatus))&&(ulStatus="Fail"),clearRequests(),clearInterval(interval),ulProgress=1,tlog("ulTest: "+ulStatus+", took "+((new Date).getTime()-s)+"ms"),u())):r>1e3*settings.time_ulGraceTime&&(0<i&&(s=(new Date).getTime(),i=n=0),a=!0))}.bind(this),200)}.bind(this);settings.mpot?(tverb("Sending POST request before performing upload test"),(xhr=[])[0]=new XMLHttpRequest,xhr[0].onload=xhr[0].onerror=function(){tverb("POST request sent, starting upload test"),s()}.bind(this),xhr[0].open("POST",settings.url_ul),xhr[0].send()):s()}}var ptCalled=!1;function pingTest(s){var n,i,a,o,l,u,g;tverb("pingTest"),ptCalled||(ptCalled=!0,n=(new Date).getTime(),i=null,u=l=o=a=0,xhr=[],(g=function(){tverb("ping"),pingProgress=l/settings.count_ping,i=(new Date).getTime(),xhr[0]=new XMLHttpRequest,xhr[0].onload=function(){if(tverb("pong"),0===l)i=(new Date).getTime();else{var t=(new Date).getTime()-i;if(settings.ping_allowPerformanceApi)try{var e=performance.getEntries(),r=(e=e[e.length-1]).responseStart-e.requestStart;0<(r=r<=0?e.duration:r)&&r<t&&(t=r)}catch(t){tverb("Performance API not supported, using estimate")}(t=t<1?u:t)<1&&(t=1);r=Math.abs(t-u);1===l?a=t:(t<a&&(a=t),o=2===l?r:o<r?.3*o+.7*r:.8*o+.2*r),u=t}pingStatus=a.toFixed(2),jitterStatus=o.toFixed(2),l++,tverb("ping: "+pingStatus+" jitter: "+jitterStatus),l<settings.count_ping?g():(pingProgress=1,tlog("ping: "+pingStatus+" jitter: "+jitterStatus+", took "+((new Date).getTime()-n)+"ms"),s())}.bind(this),xhr[0].onerror=function(){tverb("ping failed"),0===settings.xhr_ignoreErrors&&(jitterStatus=pingStatus="Fail",clearRequests(),tlog("ping test failed, took "+((new Date).getTime()-n)+"ms"),pingProgress=1,s()),1===settings.xhr_ignoreErrors&&g(),2===settings.xhr_ignoreErrors&&(++l<settings.count_ping?g():(pingProgress=1,tlog("ping: "+pingStatus+" jitter: "+jitterStatus+", took "+((new Date).getTime()-n)+"ms"),s()))}.bind(this),xhr[0].open("GET",settings.url_ping+url_sep(settings.url_ping)+(settings.mpot?"cors=true&":"")+"r="+Math.random(),!0),xhr[0].send()}.bind(this))())}function sendTelemetry(r){if(!(settings.telemetry_level<1)){(xhr=new XMLHttpRequest).onload=function(){try{var t=xhr.responseText.split(" ");if("id"==t[0])try{var e=t[1];r(e)}catch(t){r(null)}else r(null)}catch(t){r(null)}},xhr.onerror=function(){console.log("TELEMETRY ERROR "+xhr.status),r(null)},xhr.open("POST",settings.url_telemetry+url_sep(settings.url_telemetry)+(settings.mpot?"cors=true&":"")+"r="+Math.random(),!0);var e={processedString:clientIp,rawIspInfo:"object"==typeof ispInfo?ispInfo:""};try{var t=new FormData;t.append("ispinfo",JSON.stringify(e)),t.append("dl",dlStatus),t.append("ul",ulStatus),t.append("ping",pingStatus),t.append("jitter",jitterStatus),t.append("log",1<settings.telemetry_level?log:""),t.append("extra",settings.telemetry_extra),xhr.send(t)}catch(t){e="extra="+encodeURIComponent(settings.telemetry_extra)+"&ispinfo="+encodeURIComponent(JSON.stringify(e))+"&dl="+encodeURIComponent(dlStatus)+"&ul="+encodeURIComponent(ulStatus)+"&ping="+encodeURIComponent(pingStatus)+"&jitter="+encodeURIComponent(jitterStatus)+"&log="+encodeURIComponent(1<settings.telemetry_level?log:"");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(e)}}}